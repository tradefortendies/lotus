<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>My Way - Lotus</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      @font-face {
        font-family: 'garet';
        src: url('/fonts/garet-book-webfont.woff2') format('woff2'),
          url('/fonts/garet-book-webfont.woff') format('woff');
        font-weight: 400;
      }

      @font-face {
        font-family: 'garet';
        src: url('/fonts/garet-medium-webfont.woff2') format('woff2'),
          url('/fonts/garet-medium-webfont.woff') format('woff');
        font-weight: 500;
      }

      @font-face {
        font-family: 'garet';
        src: url('/fonts/garet-bold-webfont.woff2') format('woff2'),
          url('/fonts/garet-bold-webfont.woff') format('woff');
        font-weight: 700;
      }

      @font-face {
        font-family: 'garet';
        src: url('/fonts/garet-heavy-webfont.woff2') format('woff2'),
          url('/fonts/garet-heavy-webfont.woff') format('woff');
        font-weight: 900;
      }

      html,
      body {
        margin: 0;
        overflow: hidden;
        font-family: 'garet', sans-serif;
        background: #222222;
        height: 100%;
      }
      #three-container {
        position: absolute;
        left: 0;
        top: 0;
      }
      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        position: relative;
        z-index: 1;
      }
      h1 {
        font-family: 'garet', sans-serif;
        color: white;
        font-weight: 400;
        font-size: 24px;
        margin-bottom: 20px;
        text-align: center;
        padding: 0 20px;
      }
      .play-btn,
      .playing-label {
        color: #222222;
        background: #ffffff;
        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 16px 24px;
        font-size: 18px;
        cursor: pointer;
        border-radius: 10px;
        letter-spacing: 0.1em;
        font-weight: 500;
        transition: 0.3s;
        gap: 20px;
      }
      .play-btn:hover,
      .playing-label:hover {
        transform: scale(1.05);
      }
      .playing-label {
        display: none;
      }
      .controls {
        display: flex;
        flex-direction: flex-row;
        gap: 20px;
        padding: 20px 0;
        position: relative;
        z-index: 1;
      }
      .controls svg path {
        transition: 0.3s;
      }
      .controls svg:hover path {
        fill: #ffd462;
      }
    </style>

    <script src="//cdnjs.cloudflare.com/ajax/libs/three.js/r73/three.min.js"></script>
    <script src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/175711/OrbitControls-2.js"></script>
  </head>
  <body>
    <audio id="song" src="" style="display: none"></audio>
    <div class="container">
      <h1>Pay Royalties. Delist. Unplant. Wait.</h1>
      <div class="play-btn">
        <div style="position: relative; transform: translateY(4px)">
          <svg
            height="35"
            width="35"
            fill="#555"
            viewBox="0 0 55 80"
            xmlns="http://www.w3.org/2000/svg"
            data-testid="audio-svg"
          >
            <g transform="matrix(1 0 0 -1 0 80)">
              <rect width="10" height="20" rx="3"></rect>
              <rect x="15" width="10" height="80" rx="3"></rect>
              <rect x="30" width="10" height="50" rx="3"></rect>
              <rect x="45" width="10" height="30" rx="3"></rect>
            </g>
          </svg>
          <svg
            style="display: none"
            height="40"
            width="40"
            fill="#FFD462"
            viewBox="0 0 55 80"
            xmlns="http://www.w3.org/2000/svg"
            data-testid="audio-svg"
          >
            <g transform="matrix(1 0 0 -1 0 80)">
              <rect width="10" height="20" rx="3">
                <animate
                  attributeName="height"
                  begin="0s"
                  dur="4.3s"
                  values="20;45;57;80;64;32;66;45;64;23;66;13;64;56;34;34;2;23;76;79;20"
                  calcMode="linear"
                  repeatCount="indefinite"
                ></animate>
              </rect>
              <rect x="15" width="10" height="80" rx="3">
                <animate
                  attributeName="height"
                  begin="0s"
                  dur="2s"
                  values="80;55;33;5;75;23;73;33;12;14;60;80"
                  calcMode="linear"
                  repeatCount="indefinite"
                ></animate>
              </rect>
              <rect x="30" width="10" height="50" rx="3">
                <animate
                  attributeName="height"
                  begin="0s"
                  dur="1.4s"
                  values="50;34;78;23;56;23;34;76;80;54;21;50"
                  calcMode="linear"
                  repeatCount="indefinite"
                ></animate>
              </rect>
              <rect x="45" width="10" height="30" rx="3">
                <animate
                  attributeName="height"
                  begin="0s"
                  dur="2s"
                  values="30;45;13;80;56;72;45;76;34;23;67;30"
                  calcMode="linear"
                  repeatCount="indefinite"
                ></animate>
              </rect>
            </g>
          </svg>
        </div>
        <div>
          <h2
            style="
              font-size: 20px;
              font-family: garet, sans-serif;
              font-weight: 400;
              color: #555;
              margin: 0;
            "
          >
            My Way
          </h2>
          <h3
            style="
              font-size: 15px;
              font-weight: 400;
              font-family: garet, sans-serif;
              color: #555;
              margin: 0;
            "
          >
            The Lotus, [Redacted]
          </h3>
        </div>
      </div>
      <div class="playing-label">
        <div style="position: relative; transform: translateY(4px)">
          <svg
            height="35"
            width="35"
            fill="#FFD462"
            viewBox="0 0 55 80"
            xmlns="http://www.w3.org/2000/svg"
            data-testid="audio-svg"
          >
            <g transform="matrix(1 0 0 -1 0 80)">
              <rect width="10" height="20" rx="3">
                <animate
                  attributeName="height"
                  begin="0s"
                  dur="4.3s"
                  values="20;45;57;80;64;32;66;45;64;23;66;13;64;56;34;34;2;23;76;79;20"
                  calcMode="linear"
                  repeatCount="indefinite"
                ></animate>
              </rect>
              <rect x="15" width="10" height="80" rx="3">
                <animate
                  attributeName="height"
                  begin="0s"
                  dur="2s"
                  values="80;55;33;5;75;23;73;33;12;14;60;80"
                  calcMode="linear"
                  repeatCount="indefinite"
                ></animate>
              </rect>
              <rect x="30" width="10" height="50" rx="3">
                <animate
                  attributeName="height"
                  begin="0s"
                  dur="1.4s"
                  values="50;34;78;23;56;23;34;76;80;54;21;50"
                  calcMode="linear"
                  repeatCount="indefinite"
                ></animate>
              </rect>
              <rect x="45" width="10" height="30" rx="3">
                <animate
                  attributeName="height"
                  begin="0s"
                  dur="2s"
                  values="30;45;13;80;56;72;45;76;34;23;67;30"
                  calcMode="linear"
                  repeatCount="indefinite"
                ></animate>
              </rect>
            </g>
          </svg>
        </div>
        <div>
          <h2
            style="
              font-size: 20px;
              font-family: garet, sans-serif;
              font-weight: 400;
              color: #555;
              margin: 0;
            "
          >
            My Way
          </h2>
          <h3
            style="
              font-size: 15px;
              font-weight: 400;
              font-family: garet, sans-serif;
              color: #555;
              margin: 0;
            "
          >
            The Lotus, [Redacted]
          </h3>
        </div>
      </div>
      <div class="controls">
        <svg
          id="play"
          width="17"
          height="17"
          viewBox="0 0 25 25"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M23.14 10.6109L2.25 0.160894C2.01209 0.043565 1.7482 -0.0111605 1.48326 0.00188909C1.21831 0.0149387 0.961073 0.0953323 0.735849 0.235472C0.510625 0.375612 0.324855 0.570868 0.196098 0.802788C0.0673404 1.03471 -0.000151637 1.29563 2.55811e-07 1.56089V22.4409C-0.000151637 22.7062 0.0673404 22.9671 0.196098 23.199C0.324855 23.4309 0.510625 23.6262 0.735849 23.7663C0.961073 23.9065 1.21831 23.9868 1.48326 23.9999C1.7482 24.0129 2.01209 23.9582 2.25 23.8409L23.14 13.3909C23.3994 13.2629 23.6178 13.0649 23.7705 12.8193C23.9232 12.5736 24.0041 12.2901 24.0041 12.0009C24.0041 11.7117 23.9232 11.4282 23.7705 11.1825C23.6178 10.9369 23.3994 10.7389 23.14 10.6109Z"
            fill="white"
          />
        </svg>
        <svg
          id="pause"
          width="12"
          height="15"
          viewBox="0 0 18 22"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          style="display: none"
        >
          <path
            d="M5.5 0H1.5C0.671573 0 0 0.671573 0 1.5V20.5C0 21.3284 0.671573 22 1.5 22H5.5C6.32843 22 7 21.3284 7 20.5V1.5C7 0.671573 6.32843 0 5.5 0Z"
            fill="white"
          />
          <path
            d="M16.5 0H12.5C11.6716 0 11 0.671573 11 1.5V20.5C11 21.3284 11.6716 22 12.5 22H16.5C17.3284 22 18 21.3284 18 20.5V1.5C18 0.671573 17.3284 0 16.5 0Z"
            fill="white"
          />
        </svg>

        <svg
          id="mute"
          width="17"
          height="16"
          viewBox="0 0 25 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M12.299 0.35495L5.24357 7.47037C5.18329 7.52223 5.10707 7.55187 5.02759 7.55437H2.39981C1.76334 7.55437 1.15294 7.8072 0.702887 8.25725C0.252836 8.7073 0 9.3177 0 9.95417V14.0578C0 14.6943 0.252836 15.3047 0.702887 15.7548C1.15294 16.2048 1.76334 16.4576 2.39981 16.4576H5.02759C5.06745 16.4559 5.10723 16.4625 5.14441 16.477C5.18158 16.4914 5.21535 16.5134 5.24357 16.5416L12.299 23.6451C12.4661 23.8136 12.6794 23.9287 12.912 23.976C13.1446 24.0232 13.3859 24.0005 13.6055 23.9106C13.8251 23.8207 14.0132 23.6676 14.1458 23.4709C14.2785 23.2741 14.3498 23.0424 14.3508 22.8051V1.20688C14.3522 0.968551 14.2826 0.735207 14.1509 0.536599C14.0191 0.337992 13.8312 0.183119 13.6111 0.0917264C13.391 0.000333711 13.1486 -0.0234382 12.9149 0.0234416C12.6813 0.0703214 12.4668 0.185729 12.299 0.35495Z"
            fill="white"
          />
          <path
            d="M21.1063 3.6067C20.9947 3.49423 20.862 3.40497 20.7158 3.34405C20.5696 3.28313 20.4127 3.25177 20.2543 3.25177C20.0959 3.25177 19.9391 3.28313 19.7929 3.34405C19.6466 3.40497 19.5139 3.49423 19.4024 3.6067C19.1789 3.83152 19.0535 4.13563 19.0535 4.45263C19.0535 4.76963 19.1789 5.07375 19.4024 5.29856C20.2891 6.18349 20.9925 7.2346 21.4725 8.39173C21.9525 9.54886 22.1995 10.7893 22.1995 12.042C22.1995 13.2947 21.9525 14.5352 21.4725 15.6923C20.9925 16.8494 20.2891 17.9005 19.4024 18.7855C19.1789 19.0103 19.0535 19.3144 19.0535 19.6314C19.0535 19.9484 19.1789 20.2525 19.4024 20.4773C19.5139 20.5898 19.6466 20.6791 19.7929 20.74C19.9391 20.8009 20.0959 20.8323 20.2543 20.8323C20.4127 20.8323 20.5696 20.8009 20.7158 20.74C20.862 20.6791 20.9947 20.5898 21.1063 20.4773C23.3411 18.2389 24.5963 15.2051 24.5963 12.042C24.5963 8.87894 23.3411 5.84514 21.1063 3.6067Z"
            fill="white"
          />
          <path
            d="M18.1666 6.60642C18.0555 6.49454 17.9234 6.40564 17.778 6.34479C17.6325 6.28394 17.4765 6.25233 17.3189 6.25178C17.1612 6.25122 17.005 6.28172 16.8591 6.34154C16.7132 6.40136 16.5806 6.48933 16.4687 6.60042C16.3568 6.71151 16.2679 6.84354 16.2071 6.98899C16.1462 7.13444 16.1146 7.29044 16.1141 7.44811C16.1135 7.60577 16.144 7.76199 16.2038 7.90787C16.2636 8.05374 16.3516 8.1864 16.4627 8.29828C17.4431 9.28319 17.9935 10.6163 17.9935 12.006C17.9935 13.3957 17.4431 14.7288 16.4627 15.7137C16.2392 15.9385 16.1138 16.2426 16.1138 16.5596C16.1138 16.8766 16.2392 17.1807 16.4627 17.4055C16.5742 17.518 16.707 17.6073 16.8532 17.6682C16.9994 17.7291 17.1562 17.7605 17.3146 17.7605C17.473 17.7605 17.6299 17.7291 17.7761 17.6682C17.9223 17.6073 18.055 17.518 18.1666 17.4055C19.5968 15.9725 20.4001 14.0306 20.4001 12.006C20.4001 9.98134 19.5968 8.03941 18.1666 6.60642Z"
            fill="white"
          />
        </svg>

        <svg
          id="unmute"
          width="10"
          height="16"
          viewBox="0 0 15 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          style="display: none"
        >
          <path
            d="M12.299 0.35495L5.24357 7.47037C5.18329 7.52223 5.10707 7.55187 5.02759 7.55437H2.39981C1.76334 7.55437 1.15294 7.8072 0.702887 8.25725C0.252836 8.7073 0 9.3177 0 9.95417V14.0578C0 14.6943 0.252836 15.3047 0.702887 15.7548C1.15294 16.2048 1.76334 16.4576 2.39981 16.4576H5.02759C5.06745 16.4559 5.10723 16.4625 5.14441 16.477C5.18158 16.4914 5.21535 16.5134 5.24357 16.5416L12.299 23.6451C12.4661 23.8136 12.6794 23.9287 12.912 23.976C13.1446 24.0232 13.3859 24.0005 13.6055 23.9106C13.8251 23.8207 14.0132 23.6676 14.1458 23.4709C14.2785 23.2741 14.3498 23.0424 14.3508 22.8051V1.20688C14.3522 0.968551 14.2826 0.735207 14.1509 0.536599C14.0191 0.337992 13.8312 0.183119 13.6111 0.0917264C13.391 0.000333711 13.1486 -0.0234382 12.9149 0.0234416C12.6813 0.0703214 12.4668 0.185729 12.299 0.35495Z"
            fill="white"
          />
        </svg>
      </div>
    </div>
    <div id="three-container"></div>

    <script>
      var mContainer
      var mCamera, mRenderer
      var mControls

      var mShadowColor = '#222222' //0x1B0914

      var mScene
      var mLight
      var mLight2
      var mLight3

      var mUseAA = true
      var mParticleCount = 250000
      var mParticleSystem

      var mDuration
      var mPathLength = 32

      var mAudioElement = document.getElementById('song')
      var mAnalyser

      var mPlayBtn = document.querySelector('.play-btn')
      var mPlayingLabel = document.querySelector('.playing-label')
      var controlPlay = document.querySelector('#play')
      var controlPause = document.querySelector('#pause')
      var controlMute = document.querySelector('#mute')
      var controlUnmute = document.querySelector('#unmute')
      var mPlayBtnContainer = document.querySelector('.container')

      controlPlay.addEventListener('click', function () {
        console.log(mAudioElement)

        mAnalyser.context.resume().then(() => {
          console.log('Playback resumed successfully')
        })

        mPlayBtn.style.display = 'none'
        mPlayingLabel.style.display = 'flex'
        mAudioElement.currentTime = 0
        mAudioElement.play()
        controlPause.style.display = 'block'
        controlPlay.style.display = 'none'

        mCamera.position.set(0, 0, 1200)
      })

      controlPause.addEventListener('click', function () {
        console.log(mAudioElement)
        mPlayBtn.style.display = 'flex'
        mPlayingLabel.style.display = 'none'
        mAudioElement.pause()
        controlPause.style.display = 'none'
        controlPlay.style.display = 'block'
      })

      controlMute.addEventListener('click', function () {
        mAudioElement.muted = true
        controlMute.style.display = 'none'
        controlUnmute.style.display = 'block'
      })

      controlUnmute.addEventListener('click', function () {
        mAudioElement.muted = false
        controlMute.style.display = 'block'
        controlUnmute.style.display = 'none'
      })

      mAudioElement.addEventListener('ended', function () {
        mPlayBtnContainer.style.display = 'flex'
      })

      window.onload = function () {
        init()
      }

      function init() {
        initAudio()
        initTHREE()
        initControls()
        initParticleSystem()

        requestAnimationFrame(tick)
        window.addEventListener('resize', resize, false)
      }

      function initAudio() {
        mAudioElement.crossOrigin = 'anonymous'
        mAudioElement.src =
          'https://lotusgang-assets.sfo3.cdn.digitaloceanspaces.com/my-way.mp3'

        mAnalyser = new SpectrumAnalyzer(mPathLength * 0.5, 0.8)
        mAnalyser.setSource(mAudioElement)
      }

      function initTHREE() {
        mRenderer = new THREE.WebGLRenderer({ antialias: mUseAA })
        mRenderer.setSize(window.innerWidth, window.innerHeight)
        //mRenderer.setClearColor(0xffffff);
        mRenderer.setClearColor(mShadowColor)

        mContainer = document.getElementById('three-container')
        mContainer.appendChild(mRenderer.domElement)

        mCamera = new THREE.PerspectiveCamera(
          60,
          window.innerWidth / window.innerHeight,
          0.1,
          5000
        )
        mCamera.position.set(0, 0, 1200)

        mScene = new THREE.Scene()

        mLight = new THREE.PointLight(0xffffff, 1, 1200, 2)
        mLight.position.set(0, 0, 0)
        mScene.add(mLight)

        mLight2 = new THREE.DirectionalLight(0xff311f, 0.25)
        mLight2.position.set(0, 1, 1)
        mScene.add(mLight2)

        mLight3 = new THREE.DirectionalLight(0x007a99, 0.25)
        mLight3.position.set(0, 1, -1)
        mScene.add(mLight3)
      }

      function initControls() {
        mControls = new THREE.OrbitControls(mCamera, mRenderer.domElement)
        mControls.autoRotate = true
        mControls.enableZoom = true
        mControls.enablePan = false
        mControls.constraint.minDistance = 10
        mControls.constraint.maxDistance = 1200
        mControls.constraint.minPolarAngle = Math.PI * 0.4
        mControls.constraint.maxPolarAngle = Math.PI * 0.6
      }

      function initParticleSystem() {
        var prefabGeometry = new THREE.PlaneGeometry(4, 4)
        var bufferGeometry = new THREE.BAS.PrefabBufferGeometry(
          prefabGeometry,
          mParticleCount
        )

        //bufferGeometry.computeVertexNormals();

        // generate additional geometry data
        var aDelayDuration = bufferGeometry.createAttribute('aDelayDuration', 2)
        var aPivot = bufferGeometry.createAttribute('aPivot', 3)
        var aAxisAngle = bufferGeometry.createAttribute('aAxisAngle', 4)
        var aColor = bufferGeometry.createAttribute('color', 3)

        var i, j, offset

        // buffer time offset
        var delay
        var duration
        var prefabDelay = 0.00015
        var vertexDelay = 0.0175
        var minDuration = 32.0
        var maxDuration = 56.5

        mDuration =
          maxDuration +
          prefabDelay * mParticleCount +
          vertexDelay * prefabGeometry.vertices.length

        for (i = 0, offset = 0; i < mParticleCount; i++) {
          delay = i * prefabDelay
          duration = THREE.Math.randFloat(minDuration, maxDuration)

          for (j = 0; j < prefabGeometry.vertices.length; j++) {
            aDelayDuration.array[offset++] = delay + j * vertexDelay
            aDelayDuration.array[offset++] = duration
          }
        }

        // buffer pivot
        var pivot = new THREE.Vector3()

        for (i = 0, offset = 0; i < mParticleCount; i++) {
          pivot.x = THREE.Math.randFloat(0, 2)
          pivot.y = THREE.Math.randFloat(0, 2)
          pivot.z = THREE.Math.randFloat(0, 2)

          for (j = 0; j < prefabGeometry.vertices.length; j++) {
            aPivot.array[offset++] = pivot.x
            aPivot.array[offset++] = pivot.y
            aPivot.array[offset++] = pivot.z
          }
        }

        // buffer axis angle
        var axis = new THREE.Vector3()
        var angle = 0

        for (i = 0, offset = 0; i < mParticleCount; i++) {
          axis.x = THREE.Math.randFloatSpread(2)
          axis.y = THREE.Math.randFloatSpread(2)
          axis.z = THREE.Math.randFloatSpread(2)
          axis.normalize()

          angle = Math.PI * THREE.Math.randInt(48, 64)

          for (j = 0; j < prefabGeometry.vertices.length; j++) {
            aAxisAngle.array[offset++] = axis.x
            aAxisAngle.array[offset++] = axis.y
            aAxisAngle.array[offset++] = axis.z
            aAxisAngle.array[offset++] = angle
          }
        }

        // buffer color
        var color = new THREE.Color()
        var h, s, l

        for (i = 0, offset = 0; i < mParticleCount; i++) {
          //h = i / mParticleCount;
          h = THREE.Math.randFloat(0.5, 1.0)
          s = THREE.Math.randFloat(0.5, 0.75)
          l = THREE.Math.randFloat(0.25, 0.5)

          color.setHSL(h, s, l)

          for (j = 0; j < prefabGeometry.vertices.length; j++) {
            aColor.array[offset++] = color.r
            aColor.array[offset++] = color.g
            aColor.array[offset++] = color.b
          }
        }

        // buffer spline (uniform)
        var pathArray = []
        var radiusArray = []
        var length = mPathLength
        var x, y, z

        for (i = 0; i < length; i++) {
          if (!i) {
            x = 0
            y = -1400
            z = 0
          } else if (!(i - length + 1)) {
            x = 0
            y = 1200
            z = 0
          } else {
            x = THREE.Math.randFloatSpread(600)
            y = -400 + (800 / length) * i + THREE.Math.randFloatSpread(200)
            z = THREE.Math.randFloatSpread(600)
          }

          pathArray.push(x, y, z)
          radiusArray.push(0)
        }

        var material = new THREE.BAS.PhongAnimationMaterial(
          // custom parameters & THREE.MeshPhongMaterial parameters
          {
            vertexColors: THREE.VertexColors,
            shading: THREE.FlatShading,
            side: THREE.DoubleSide,
            defines: {
              PATH_LENGTH: pathArray.length / 3,
            },
            uniforms: {
              uTime: { type: 'f', value: 0 },
              uPath: { type: 'fv', value: pathArray },
              uRadius: { type: 'fv1', value: radiusArray },
              uRoundness: { type: 'v2', value: new THREE.Vector2(2, 2) },
            },
            shaderFunctions: [
              THREE.BAS.ShaderChunk['quaternion_rotation'],
              THREE.BAS.ShaderChunk['catmull-rom'],
              THREE.BAS.ShaderChunk['ease_in_out_cubic'],
            ],
            shaderParameters: [
              'uniform float uTime;',
              'uniform vec3 uPath[PATH_LENGTH];',
              'uniform float uRadius[PATH_LENGTH];',
              'uniform vec2 uRoundness;',
              'attribute vec2 aDelayDuration;',
              'attribute vec3 aPivot;',
              'attribute vec4 aAxisAngle;',
            ],
            shaderVertexInit: [
              'float tDelay = aDelayDuration.x;',
              'float tDuration = aDelayDuration.y;',
              'float tTime = clamp(uTime - tDelay, 0.0, tDuration);',
              'float tProgress = tTime / tDuration;',

              'float angle = aAxisAngle.w * tProgress;',
              'vec4 tQuat = quatFromAxisAngle(aAxisAngle.xyz, angle);',
            ],
            shaderTransformNormal: [
              'objectNormal = rotateVector(tQuat, objectNormal);',
            ],
            shaderTransformPosition: [
              'float tMax = float(PATH_LENGTH - 1);',
              'float tPoint = tMax * tProgress;',
              'float tIndex = floor(tPoint);',
              'float tWeight = tPoint - tIndex;',

              'int i0 = int(max(0.0, tIndex - 1.0));',
              'int i1 = int(tIndex);',
              'int i2 = int(min(tIndex + 1.0, tMax));',
              'int i3 = int(min(tIndex + 2.0, tMax));',
              'vec3 p0 = uPath[i0];',
              'vec3 p1 = uPath[i1];',
              'vec3 p2 = uPath[i2];',
              'vec3 p3 = uPath[i3];',

              'float radius = catmullRom(uRadius[i0], uRadius[i1], uRadius[i2], uRadius[i3], tWeight);',
              'transformed += aPivot * radius;',

              'transformed = rotateVector(tQuat, transformed);',

              'transformed += catmullRom(p0, p1, p2, p3, uRoundness, tWeight);',
            ],
          },
          // THREE.MeshPhongMaterial uniforms
          {
            shininess: 16,
            specular: 0xffd700,
            emissive: mShadowColor,
          }
        )

        mParticleSystem = new THREE.Mesh(bufferGeometry, material)
        mParticleSystem.frustumCulled = false

        mScene.add(mParticleSystem)
      }

      function tick() {
        update()
        render()

        requestAnimationFrame(tick)
      }

      function update() {
        mControls.update()
        mAnalyser.updateSample()

        var uniform = mParticleSystem.material.uniforms['uRadius'].value
        var data = mAnalyser.frequencyByteData

        var dataArray = []
        var cap = data.length * 0.5
        var i

        //for (i = cap - 1; i >= 0; i--) {
        for (i = 0; i < cap; i++) {
          dataArray.push(data[i])
        }

        for (i = cap - 1; i >= 0; i--) {
          //for (i = 0; i < cap; i++) {
          dataArray.push(data[i])
        }

        //for (i = cap - 1; i >= 0; i--) {
        for (i = 0; i < cap; i++) {
          dataArray.push(data[i])
        }

        for (i = cap - 1; i >= 0; i--) {
          //for (i = 0; i < cap; i++) {
          dataArray.push(data[i])
        }

        for (i = 0; i < dataArray.length; i++) {
          if (i && dataArray.length - i > 1) {
            var val = dataArray[i] / 255
            uniform[i] = Math.max(1, val * val * val * 48)
          } else {
            uniform[i] = 128
          }
        }

        var a0 = mAnalyser.getAverageFloat()
        var r = 8 * a0 * a0 * a0 + 1
        mParticleSystem.material.uniforms['uRoundness'].value.set(r, r)

        var a1 = mAnalyser.getAverageFloat() * 2
        mLight.intensity = a1 * a1
        mLight2.intensity = a1 * a1 * a1 * a1 * 0.5
        mLight3.intensity = a1 * a1 * a1 * a1 * 0.5

        mParticleSystem.material.uniforms['uTime'].value =
          mAudioElement.currentTime || 0
      }

      function render() {
        mRenderer.render(mScene, mCamera)
      }

      function resize() {
        mCamera.aspect = window.innerWidth / window.innerHeight
        mCamera.updateProjectionMatrix()

        mRenderer.setSize(window.innerWidth, window.innerHeight)
      }

      /////////////////////////////////
      // Spectrum Analyser
      /////////////////////////////////

      // https://developer.mozilla.org/en-US/docs/Web/API/AnalyserNode
      function SpectrumAnalyzer(binCount, smoothingTimeConstant) {
        var Context = window['AudioContext'] || window['webkitAudioContext']

        this.context = new Context()
        this.analyzerNode = this.context.createAnalyser()

        this.setBinCount(binCount)
        this.setSmoothingTimeConstant(smoothingTimeConstant)
      }

      SpectrumAnalyzer.prototype = {
        setSource: function (source) {
          //this.source = source;
          this.source = this.context.createMediaElementSource(source)
          this.source.connect(this.analyzerNode)
          this.analyzerNode.connect(this.context.destination)
        },

        setBinCount: function (binCount) {
          this.binCount = binCount
          this.analyzerNode.fftSize = binCount * 2

          this.frequencyByteData = new Uint8Array(binCount) // frequency
          this.timeByteData = new Uint8Array(binCount) // waveform
        },

        setSmoothingTimeConstant: function (smoothingTimeConstant) {
          this.analyzerNode.smoothingTimeConstant = smoothingTimeConstant
        },

        getFrequencyData: function () {
          return this.frequencyByteData
        },

        getTimeData: function () {
          return this.timeByteData
        },
        // not save if out of bounds
        getAverage: function (index, count) {
          var total = 0
          var start = index || 0
          var end = start + (count || this.binCount)

          for (var i = start; i < end; i++) {
            total += this.frequencyByteData[i]
          }

          return total / (end - start)
        },
        getAverageFloat: function (index, count) {
          return this.getAverage(index, count) / 255
        },

        updateSample: function () {
          this.analyzerNode.getByteFrequencyData(this.frequencyByteData)
          this.analyzerNode.getByteTimeDomainData(this.timeByteData)
        },
      }

      ///////////////
      // buffer animation system
      ///////////////

      THREE.BAS = {}

      THREE.BAS.ShaderChunk = {}

      THREE.BAS.ShaderChunk['animation_time'] =
        'float tDelay = aAnimation.x;\nfloat tDuration = aAnimation.y;\nfloat tTime = clamp(uTime - tDelay, 0.0, tDuration);\nfloat tProgress = ease(tTime, 0.0, 1.0, tDuration);\n'

      THREE.BAS.ShaderChunk['catmull-rom'] =
        'vec3 catmullRom(vec3 p0, vec3 p1, vec3 p2, vec3 p3, float t)\n{\n    vec3 v0 = (p2 - p0) * 0.5;\n    vec3 v1 = (p3 - p1) * 0.5;\n    float t2 = t * t;\n    float t3 = t * t * t;\n\n    return vec3((2.0 * p1 - 2.0 * p2 + v0 + v1) * t3 + (-3.0 * p1 + 3.0 * p2 - 2.0 * v0 - v1) * t2 + v0 * t + p1);\n}\n\nvec3 catmullRom(vec3 p0, vec3 p1, vec3 p2, vec3 p3, vec2 c, float t)\n{\n    vec3 v0 = (p2 - p0) * c.x;\n    vec3 v1 = (p3 - p1) * c.y;\n    float t2 = t * t;\n    float t3 = t * t * t;\n\n    return vec3((2.0 * p1 - 2.0 * p2 + v0 + v1) * t3 + (-3.0 * p1 + 3.0 * p2 - 2.0 * v0 - v1) * t2 + v0 * t + p1);\n}\n\nfloat catmullRom(float p0, float p1, float p2, float p3, float t)\n{\n    float v0 = (p2 - p0) * 0.5;\n    float v1 = (p3 - p1) * 0.5;\n    float t2 = t * t;\n    float t3 = t * t * t;\n\n    return float((2.0 * p1 - 2.0 * p2 + v0 + v1) * t3 + (-3.0 * p1 + 3.0 * p2 - 2.0 * v0 - v1) * t2 + v0 * t + p1);\n}\n\nfloat catmullRom(float p0, float p1, float p2, float p3, vec2 c, float t)\n{\n    float v0 = (p2 - p0) * c.x;\n    float v1 = (p3 - p1) * c.y;\n    float t2 = t * t;\n    float t3 = t * t * t;\n\n    return float((2.0 * p1 - 2.0 * p2 + v0 + v1) * t3 + (-3.0 * p1 + 3.0 * p2 - 2.0 * v0 - v1) * t2 + v0 * t + p1);\n}\n'

      THREE.BAS.ShaderChunk['cubic_bezier'] =
        'vec3 cubicBezier(vec3 p0, vec3 c0, vec3 c1, vec3 p1, float t)\n{\n    vec3 tp;\n    float tn = 1.0 - t;\n\n    tp.xyz = tn * tn * tn * p0.xyz + 3.0 * tn * tn * t * c0.xyz + 3.0 * tn * t * t * c1.xyz + t * t * t * p1.xyz;\n\n    return tp;\n}\n'

      THREE.BAS.ShaderChunk['ease_in_cubic'] =
        'float ease(float t, float b, float c, float d) {\n  return c*(t/=d)*t*t + b;\n}\n'

      THREE.BAS.ShaderChunk['ease_in_out_cubic'] =
        'float ease(float t, float b, float c, float d) {\n  if ((t/=d/2.0) < 1.0) return c/2.0*t*t*t + b;\n  return c/2.0*((t-=2.0)*t*t + 2.0) + b;\n}\n'

      THREE.BAS.ShaderChunk['ease_in_quad'] =
        'float ease(float t, float b, float c, float d) {\n  return c*(t/=d)*t + b;\n}\n'

      THREE.BAS.ShaderChunk['ease_out_cubic'] =
        'float ease(float t, float b, float c, float d) {\n  return c*((t=t/d - 1.0)*t*t + 1.0) + b;\n}\n'

      THREE.BAS.ShaderChunk['quaternion_rotation'] =
        'vec3 rotateVector(vec4 q, vec3 v)\n{\n    return v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\n\nvec4 quatFromAxisAngle(vec3 axis, float angle)\n{\n    float halfAngle = angle * 0.5;\n    return vec4(axis.xyz * sin(halfAngle), cos(halfAngle));\n}\n'

      THREE.BAS.PrefabBufferGeometry = function (prefab, count) {
        THREE.BufferGeometry.call(this)

        this.prefabGeometry = prefab
        this.prefabCount = count
        this.prefabVertexCount = prefab.vertices.length

        this.bufferDefaults()
      }
      THREE.BAS.PrefabBufferGeometry.prototype = Object.create(
        THREE.BufferGeometry.prototype
      )
      THREE.BAS.PrefabBufferGeometry.prototype.constructor =
        THREE.BAS.PrefabBufferGeometry

      THREE.BAS.PrefabBufferGeometry.prototype.bufferDefaults = function () {
        var prefabFaceCount = this.prefabGeometry.faces.length
        var prefabIndexCount = this.prefabGeometry.faces.length * 3
        var prefabVertexCount = (this.prefabVertexCount =
          this.prefabGeometry.vertices.length)
        var prefabIndices = []

        //console.log('prefabCount', this.prefabCount);
        //console.log('prefabFaceCount', prefabFaceCount);
        //console.log('prefabIndexCount', prefabIndexCount);
        //console.log('prefabVertexCount', prefabVertexCount);
        //console.log('triangles', prefabFaceCount * this.prefabCount);

        for (var h = 0; h < prefabFaceCount; h++) {
          var face = this.prefabGeometry.faces[h]
          prefabIndices.push(face.a, face.b, face.c)
        }

        var indexBuffer = new Uint32Array(this.prefabCount * prefabIndexCount)
        var positionBuffer = new Float32Array(
          this.prefabCount * prefabVertexCount * 3
        )

        this.setIndex(new THREE.BufferAttribute(indexBuffer, 1))
        this.addAttribute(
          'position',
          new THREE.BufferAttribute(positionBuffer, 3)
        )

        for (var i = 0, offset = 0; i < this.prefabCount; i++) {
          for (var j = 0; j < prefabVertexCount; j++, offset += 3) {
            var prefabVertex = this.prefabGeometry.vertices[j]

            positionBuffer[offset] = prefabVertex.x
            positionBuffer[offset + 1] = prefabVertex.y
            positionBuffer[offset + 2] = prefabVertex.z
          }

          for (var k = 0; k < prefabIndexCount; k++) {
            indexBuffer[i * prefabIndexCount + k] =
              prefabIndices[k] + i * prefabVertexCount
          }
        }
      }

      // todo test
      THREE.BAS.PrefabBufferGeometry.prototype.bufferUvs = function () {
        var prefabFaceCount = this.prefabGeometry.faces.length
        var prefabVertexCount = (this.prefabVertexCount =
          this.prefabGeometry.vertices.length)
        var prefabUvs = []

        for (var h = 0; h < prefabFaceCount; h++) {
          var face = this.prefabGeometry.faces[h]
          var uv = this.prefabGeometry.faceVertexUvs[0][h]

          prefabUvs[face.a] = uv[0]
          prefabUvs[face.b] = uv[1]
          prefabUvs[face.c] = uv[2]
        }

        var uvBuffer = this.createAttribute('uv', 2)

        for (var i = 0, offset = 0; i < this.prefabCount; i++) {
          for (var j = 0; j < prefabVertexCount; j++, offset += 2) {
            var prefabUv = prefabUvs[j]

            uvBuffer.array[offset] = prefabUv.x
            uvBuffer.array[offset + 1] = prefabUv.y
          }
        }
      }

      /**
       * based on BufferGeometry.computeVertexNormals
       * calculate vertex normals for a prefab, and repeat the data in the normal buffer
       */
      THREE.BAS.PrefabBufferGeometry.prototype.computeVertexNormals =
        function () {
          var index = this.index
          var attributes = this.attributes
          var positions = attributes.position.array

          if (attributes.normal === undefined) {
            this.addAttribute(
              'normal',
              new THREE.BufferAttribute(new Float32Array(positions.length), 3)
            )
          }

          var normals = attributes.normal.array

          var vA,
            vB,
            vC,
            pA = new THREE.Vector3(),
            pB = new THREE.Vector3(),
            pC = new THREE.Vector3(),
            cb = new THREE.Vector3(),
            ab = new THREE.Vector3()

          var indices = index.array
          var prefabIndexCount = this.prefabGeometry.faces.length * 3

          for (var i = 0; i < prefabIndexCount; i += 3) {
            vA = indices[i + 0] * 3
            vB = indices[i + 1] * 3
            vC = indices[i + 2] * 3

            pA.fromArray(positions, vA)
            pB.fromArray(positions, vB)
            pC.fromArray(positions, vC)

            cb.subVectors(pC, pB)
            ab.subVectors(pA, pB)
            cb.cross(ab)

            normals[vA] += cb.x
            normals[vA + 1] += cb.y
            normals[vA + 2] += cb.z

            normals[vB] += cb.x
            normals[vB + 1] += cb.y
            normals[vB + 2] += cb.z

            normals[vC] += cb.x
            normals[vC + 1] += cb.y
            normals[vC + 2] += cb.z
          }

          for (var j = 1; j < this.prefabCount; j++) {
            for (var k = 0; k < prefabIndexCount; k++) {
              normals[j * prefabIndexCount + k] = normals[k]
            }
          }

          this.normalizeNormals()

          attributes.normal.needsUpdate = true
        }

      THREE.BAS.PrefabBufferGeometry.prototype.createAttribute = function (
        name,
        itemSize
      ) {
        var buffer = new Float32Array(
          this.prefabCount * this.prefabVertexCount * itemSize
        )
        var attribute = new THREE.BufferAttribute(buffer, itemSize)

        this.addAttribute(name, attribute)

        return attribute
      }

      THREE.BAS.PrefabBufferGeometry.prototype.setAttribute4 = function (
        name,
        data
      ) {
        var offset = 0
        var array = this.geometry.attributes[name].array
        var i, j

        for (i = 0; i < data.length; i++) {
          var v = data[i]

          for (j = 0; j < this.prefabVertexCount; j++) {
            array[offset++] = v.x
            array[offset++] = v.y
            array[offset++] = v.z
            array[offset++] = v.w
          }
        }

        this.geometry.attributes[name].needsUpdate = true
      }
      THREE.BAS.PrefabBufferGeometry.prototype.setAttribute3 = function (
        name,
        data
      ) {
        var offset = 0
        var array = this.geometry.attributes[name].array
        var i, j

        for (i = 0; i < data.length; i++) {
          var v = data[i]

          for (j = 0; j < this.prefabVertexCount; j++) {
            array[offset++] = v.x
            array[offset++] = v.y
            array[offset++] = v.z
          }
        }

        this.geometry.attributes[name].needsUpdate = true
      }
      THREE.BAS.PrefabBufferGeometry.prototype.setAttribute2 = function (
        name,
        data
      ) {
        var offset = 0
        var array = this.geometry.attributes[name].array
        var i, j

        for (i = 0; i < this.prefabCount; i++) {
          var v = data[i]

          for (j = 0; j < this.prefabVertexCount; j++) {
            array[offset++] = v.x
            array[offset++] = v.y
          }
        }

        this.geometry.attributes[name].needsUpdate = true
      }

      THREE.BAS.BaseAnimationMaterial = function (parameters) {
        THREE.ShaderMaterial.call(this)

        this.shaderFunctions = []
        this.shaderParameters = []
        this.shaderVertexInit = []
        this.shaderTransformNormal = []
        this.shaderTransformPosition = []

        this.setValues(parameters)
      }
      THREE.BAS.BaseAnimationMaterial.prototype = Object.create(
        THREE.ShaderMaterial.prototype
      )
      THREE.BAS.BaseAnimationMaterial.prototype.constructor =
        THREE.BAS.BaseAnimationMaterial

      // abstract
      THREE.BAS.BaseAnimationMaterial.prototype._concatVertexShader =
        function () {
          return ''
        }

      THREE.BAS.BaseAnimationMaterial.prototype._concatFunctions = function () {
        return this.shaderFunctions.join('\n')
      }
      THREE.BAS.BaseAnimationMaterial.prototype._concatParameters =
        function () {
          return this.shaderParameters.join('\n')
        }
      THREE.BAS.BaseAnimationMaterial.prototype._concatVertexInit =
        function () {
          return this.shaderVertexInit.join('\n')
        }
      THREE.BAS.BaseAnimationMaterial.prototype._concatTransformNormal =
        function () {
          return this.shaderTransformNormal.join('\n')
        }
      THREE.BAS.BaseAnimationMaterial.prototype._concatTransformPosition =
        function () {
          return this.shaderTransformPosition.join('\n')
        }

      THREE.BAS.BaseAnimationMaterial.prototype.setUniformValues = function (
        values
      ) {
        for (var key in values) {
          if (key in this.uniforms) {
            var uniform = this.uniforms[key]
            var value = values[key]

            // todo add matrix uniform types
            switch (uniform.type) {
              case 'c': // color
                uniform.value.set(value)
                break
              case 'v2': // vectors
              case 'v3':
              case 'v4':
                uniform.value.copy(value)
                break
              case 'f': // float
              case 't': // texture
              default:
                uniform.value = value
            }
          }
        }
      }

      THREE.BAS.PhongAnimationMaterial = function (parameters, uniformValues) {
        THREE.BAS.BaseAnimationMaterial.call(this, parameters)

        var phongShader = THREE.ShaderLib['phong']

        this.uniforms = THREE.UniformsUtils.merge([
          phongShader.uniforms,
          this.uniforms,
        ])
        this.lights = true
        this.vertexShader = this._concatVertexShader()
        this.fragmentShader = phongShader.fragmentShader

        // todo add missing default defines
        uniformValues.map && (this.defines['USE_MAP'] = '')
        uniformValues.normalMap && (this.defines['USE_NORMALMAP'] = '')

        this.setUniformValues(uniformValues)
      }
      THREE.BAS.PhongAnimationMaterial.prototype = Object.create(
        THREE.BAS.BaseAnimationMaterial.prototype
      )
      THREE.BAS.PhongAnimationMaterial.prototype.constructor =
        THREE.BAS.PhongAnimationMaterial

      THREE.BAS.PhongAnimationMaterial.prototype._concatVertexShader =
        function () {
          // based on THREE.ShaderLib.phong
          return [
            '#define PHONG',

            'varying vec3 vViewPosition;',

            '#ifndef FLAT_SHADED',

            '	varying vec3 vNormal;',

            '#endif',

            THREE.ShaderChunk['common'],
            THREE.ShaderChunk['uv_pars_vertex'],
            THREE.ShaderChunk['uv2_pars_vertex'],
            THREE.ShaderChunk['displacementmap_pars_vertex'],
            THREE.ShaderChunk['envmap_pars_vertex'],
            THREE.ShaderChunk['lights_phong_pars_vertex'],
            THREE.ShaderChunk['color_pars_vertex'],
            THREE.ShaderChunk['morphtarget_pars_vertex'],
            THREE.ShaderChunk['skinning_pars_vertex'],
            THREE.ShaderChunk['shadowmap_pars_vertex'],
            THREE.ShaderChunk['logdepthbuf_pars_vertex'],

            this._concatFunctions(),

            this._concatParameters(),

            'void main() {',

            this._concatVertexInit(),

            THREE.ShaderChunk['uv_vertex'],
            THREE.ShaderChunk['uv2_vertex'],
            THREE.ShaderChunk['color_vertex'],
            THREE.ShaderChunk['beginnormal_vertex'],

            this._concatTransformNormal(),

            THREE.ShaderChunk['morphnormal_vertex'],
            THREE.ShaderChunk['skinbase_vertex'],
            THREE.ShaderChunk['skinnormal_vertex'],
            THREE.ShaderChunk['defaultnormal_vertex'],

            '#ifndef FLAT_SHADED', // Normal computed with derivatives when FLAT_SHADED

            '	vNormal = normalize( transformedNormal );',

            '#endif',

            THREE.ShaderChunk['begin_vertex'],

            this._concatTransformPosition(),

            THREE.ShaderChunk['displacementmap_vertex'],
            THREE.ShaderChunk['morphtarget_vertex'],
            THREE.ShaderChunk['skinning_vertex'],
            THREE.ShaderChunk['project_vertex'],
            THREE.ShaderChunk['logdepthbuf_vertex'],

            '	vViewPosition = - mvPosition.xyz;',

            THREE.ShaderChunk['worldpos_vertex'],
            THREE.ShaderChunk['envmap_vertex'],
            THREE.ShaderChunk['lights_phong_vertex'],
            THREE.ShaderChunk['shadowmap_vertex'],

            '}',
          ].join('\n')
        }
    </script>
  </body>
</html>
